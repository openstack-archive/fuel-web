<div class="modal-header">
  <button type="button" class="close" data-dismiss="modal">Ã—</button>
  <h3 data-i18n="dialog.display_changes.title"></h3>
</div>
<div class="modal-body display-changes-dialog">

  <!-- Changes list -->
  <% var nodes = cluster.get('nodes') %>
  <% var addedNodes = nodes.where({pending_addition: true}) %>
  <% if (addedNodes.length) { %>
    <div class="deploy-task-name"><%- $.t("dialog.display_changes.added_node", {count: addedNodes.length }) %></div>
  <% } %>
  <% var deletedNodes = nodes.where({pending_deletion: true}) %>
  <% if (deletedNodes.length) { %>
    <div class="deploy-task-name"><%- $.t("dialog.display_changes.deleted_node", {count: deletedNodes.length }) %></div>
  <% } %>
  <% var reconfiguredNodes = nodes.filter(function(node) {return !node.get('pending_addition') && !node.get('pending_deletion') && !_.isEmpty(node.get('pending_roles'));}) %>
  <% if (reconfiguredNodes.length) { %>
    <div class="deploy-task-name"><%- $.t("dialog.display_changes.reconfigured_node", {count: reconfiguredNodes.length }) %></div>
  <% } %>

  <% var settingsChangesDescriptions = {
      'attributes': $.t("dialog.display_changes.settings_changes.attrs"),
      'networks': $.t("dialog.display_changes.settings_changes.networks"),
      'disks': $.t("dialog.display_changes.settings_changes.disks")
  } %>
  <% _.each(_.reject(cluster.get('changes'), {name: 'disks'}), function(change) { %>
    <div class="deploy-task-name"><%- $.t("dialog.display_changes.changed_task_name", {item: settingsChangesDescriptions[change.name] }) %> </div>
  <% }) %>
  <% var nodesWithChangedDisks = _.pluck(_.where(cluster.get('changes'), {name: 'disks'}), 'node_id') %>
  <% if (nodesWithChangedDisks.length) { %>
    <div class="deploy-task-name"><%- $.t("dialog.display_changes.changed_task_name", {item: settingsChangesDescriptions.disks }) %> </div>
    <ul>
      <% _.each(nodesWithChangedDisks, function(nodeId) { %>
        <% if (nodes.get(nodeId)) { %>
          <li><%- nodes.get(nodeId).get('name') %></li>
        <% } %>
      <% }) %>
    </ul>
  <% } %>

  <!-- Warnings -->
  <% var warnings = [], recommendations = [];
    if (cluster.needsRedeployment()) { warnings.push($.t("dialog.display_changes.redeployment_needed")); }
    function handleLimit(limitType, warnings) {
      var roleLimit = role.getLimit(limitType);
      if (!_.isNull(roleLimit.limit) && roleLimit.limit > nodesWithRole.length) {
        warnings.push(roleLimit.warning || $.t("dialog.display_changes." + limitType + "_role_warning", {count: roleLimit.limit, role: role.get('label')}));
      }
    }
    cluster.get('release').get('roles').each(function(role) {
      var nodesWithRole = cluster.getNodesByRole(role.get('name');
      handleLimit('min', warnings);
      handleLimit('recommended', warnings);
    });
  %>
  <% if (warnings.length || recommendations.length) { %>
    <hr class="slim">
    <% _.each(recommendations, function(recommendation) { %>
      <div class="alert alert-warning"><%- recommendation %></div>
    <% }) %>
    <% _.each(warnings, function(warning) { %>
      <div class="alert alert-error"><%- warning %></div>
    <% }) %>
  <% } %>

</div>
<div class="modal-footer">
  <button class="btn" data-dismiss="modal" data-i18n="common.cancel_button"></button>
  <button class="btn btn-<%= warnings.length ? 'danger' : 'success' %> start-deployment-btn" data-i18n="dialog.display_changes.deploy"></button>
</div>
